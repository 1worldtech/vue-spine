/**
 * vue-spine v0.0.4
 * (c) 2017 Thorsten Eckel
 * @license MIT
 */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("vue")):"function"==typeof define&&define.amd?define(["exports","vue"],e):e(t["Vue-Spine"]=t["Vue-Spine"]||{},t.Vue)}(this,function(t,e){"use strict";e="default"in e?e.default:e;var i=function(t){var e=t.replace(/[-_\s]+(.)?/g,function(t,e){return e?e.toUpperCase():""});return e.charAt(0).toUpperCase()+e.slice(1)},n={namespaced:!0,state:function(){return{records:{},tmpRecords:[]}},mutations:{addTemporary:function(t,e){t.tmpRecords.push(e)},changeID:function(t,i){e.set(t.records,i.to,t.records[i.from]),e.delete(t.records,i.from),t.records[i.to].id=i.to},updateAttribute:function(t,e){t.records[e.id][e.name]=e.value},delete:function(t,i){e.delete(t.records,i)},deleteAll:function(t){t.records={},t.tmpRecords=[]},addRecord:function(t,i){e.set(t.records,i.id,i)},updateRecord:function(t,e){var i=t.records[e.id];Object.keys(e).sort().forEach(function(t){"id"!==t&&(i[t]=e[t])})}},getters:{isNew:function(t){return function(e){return Boolean(t.tmpRecords.find(function(t){return t===e}))}},find:function(t){return function(e){return t.records[e]}},findAll:function(t){return function(e){var i=[];return e.forEach(function(e){var n=t.records[e];n&&i.push(n)}),i}},exists:function(t,e){return function(t){return Boolean(e.find(t))}},select:function(t){return function(i){var n=[];return Object.keys(t.records).sort().forEach(function(r){var o=t.records[r];i(o)&&e.set(n,n.length,o)}),n}},findBy:function(t){return function(e,i){var n;return Object.keys(t.records).sort().some(function(r){var o=t.records[r];if(o[e]===i)return n=o,!0}),n}},findAllBy:function(t,e){return function(t,i){return e.select(function(e){return e[t]===i})}},all:function(t,e){return function(){return e.select(function(t){return!0})}}}},r=function(t){var e=this;void 0===t&&(t={}),this.store=this.constructor.store,this.vm=this.constructor.vm,this.namespace=this.constructor.namespace,this.conf=this.constructor.conf,this.properties=this.constructor.attributes.slice(),this.properties.forEach(function(e){t[e.name]||(t[e.name]=null)}),this.properties.push({name:"id"}),this.constructor.idCounter||(this.constructor.idCounter=1),this.reactiveAttributes={},t.id?this.reactiveAttributes=t:(t.id=this.constructor.uid("c-"),this.reactiveAttributes.id=t.id,this.mutation("addTemporary",t.id),Promise.resolve(this.constructor.load(t)).then(function(t){e.reactiveAttributes=t})),this.associations={},this.properties.forEach(function(t){var i=e._propertyConfig(t);e._initializeAssociation(i);var n={get:function(){if(!this.deleted)return this.reactiveAttributes[i.name]}};"id"!==i.name&&Object.assign(n,{set:function(t){this.deleted||this.mutation("updateAttribute",{id:this.id,name:i.name,value:t})}}),Object.defineProperty(e,i.name,n)})},o={attributes:{}};r.registerStore=function(t,e,i){this.vm=t,this.store=this.vm.$store,this.namespace=e,this.conf=i;var r=this.vm.$[e];if(r)return void(r.name!==this.name&&console.error("[spine] differing model registration: "+this.name+" as "+e+", but "+r.name+" is registered"));this.vm.$[e]=this,this.store.registerModule(e,n)},o.attributes.get=function(){return[{name:"name"}]},r.uid=function(t){void 0===t&&(t="");var e=t+this.idCounter++;return this.exists(e)&&(e=this.uid),e},r.find=function(t){var e=this.getter("find",t);if(e)return new this(e)},r.findAll=function(t){return this.getter("findAll",t)},r.exists=function(t){return this.getter("exists",t)},r.select=function(t){return this.getter("select",t)},r.findBy=function(t,e){return this.getter("findBy",t,e)},r.findAllBy=function(t,e){return this.getter("findAllBy",t,e)},r.all=function(){return this.getter("all")},r.deleteAll=function(){this.mutation("deleteAll")},r.updateRecord=function(t){this.mutation("updateRecord",t)},r.addRecord=function(t){this.mutation("addRecord",t)},r.load=function(t){return this.exists(t.id)?this.updateRecord(t):this.addRecord(t),this.find(t.id)},r.isNew=function(t){return this.getter("isNew",t)},r.delete=function(t){this.mutation("delete",t)},r.changeID=function(t,e){this.mutation("changeID",{from:t,to:e})},r.mutation=function(t,e){this.store.commit(this.namespace+"/"+t,e)},r.getter=function(t){var e=Array.prototype.slice.call(arguments,1);return(i=this.store.getters)[this.namespace+"/"+t].apply(i,e);var i},r.prototype.isNew=function(){return this.constructor.isNew(this.id)},r.prototype.delete=function(){this.constructor.delete(this.id),this.reactiveAttributes={}},r.prototype.changeID=function(t){this.constructor.changeID(this.id,t)},r.prototype.save=function(){this.validate(),this.preserve()},r.prototype.attributes=function(){var t=this,e={};return this.properties.forEach(function(i){e[i.name]=t[i.name]}),e},r.prototype.mutation=function(){(t=this.constructor).mutation.apply(t,arguments);var t},r.prototype.getter=function(){return(t=this.constructor).getter.apply(t,arguments);var t},r.prototype.validate=function(){},r.prototype.preserve=function(){console.warn("[spine] missing preserve implementation for "+this.constructor.name+" instance with ID "+this.id+".")},r.prototype.destroy=function(){this.delete(),console.warn("[spine] missing destroy implementation for "+this.constructor.name+" instance with ID "+this.id+".")},r.prototype._propertyConfig=function(t){return"object"==typeof t?t:"string"==typeof t?{name:t}:void 0},r.prototype._initializeAssociation=function(t){this.constructor.associations||(this.associations=this.constructor.associations={});var e=this._associationConfig(t);e.type&&(this.constructor.associations[e.property]=e,Object.defineProperty(this,e.accessor,e.definition))},r.prototype._associationConfig=function(t){var e=this._associationObject(t);return this._associationType(e),e.type&&(this._associationAccessor(e),this._associationClass(e),this._associationDefinition(e)),e},r.prototype._associationObject=function(t){var e=t.association||{};return e.property=t.name,e},r.prototype._associationType=function(t){t.type||(t.property.endsWith("_ids")?t.type="has_many":t.property.endsWith("_id")&&(t.type="has"))},r.prototype._associationAccessor=function(t){t.accessor||(t.accessor=t.property.replace(/_id(s)?$/,"$1"))},r.prototype._associationClass=function(t){t.className||(t.className=i(t.property.replace(/_ids?$/,"")))},r.prototype._associationDefinition=function(t){"has"===t.type?t.definition={get:function(){if(!this.deleted){var e=this[t.property];return this.vm.$[t.className].find(e)}},set:function(e){this.deleted||(this[t.property]=e.id)}}:"has_many"===t.type&&(t.definition={get:function(){var e=this,i=[];return this[t.property].forEach(function(n){var r=e.vm.$[t.className].find(n);i.push(r)}),i},set:function(e){if(!this.deleted){var i=[];e.forEach(function(t){i.push(t.id)}),this[t.property]=i}}})},Object.defineProperties(r,o);var s,c=function(t){function e(){t.apply(this,arguments)}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.findByAttribute=function(){return(t=this).findBy.apply(t,arguments);var t},e.findAllByAttribute=function(){return(t=this).findAllBy.apply(t,arguments);var t},e.prototype.updateAttribute=function(t,e){var i={};i[t]=e,this.updateAttributes(i)},e.prototype.updateAttributes=function(t){var e=this;Object.keys(t).forEach(function(i){e[i]=t[i]}),this.save()},e.prototype.attributes=function(){var t=this,e={};return this.properties.forEach(function(i){e[i.name]=t[i.name]}),e},e.prototype.exists=function(){return this.constructor.exists(this.id)},e.prototype.remove=function(){this.delete()},e}(r),u=function(t,e){function i(){var t=this,i=this.$options;this.$||(i.parent&&i.parent.$?this.$=i.parent.$:this.$={}),i.spine&&Object.keys(i.spine).forEach(function(n){i.spine[n].registerStore(t,n,e)})}if(void 0===e&&(e={}),s)return void console.error("[spine] already installed. Vue.use(Spine) should be called only once.");s=t;var n=s.config._lifecycleHooks.indexOf("init")>-1;s.mixin(n?{init:i}:{beforeCreate:i})},a={Model:r,LegacyModel:c,storeModule:n,install:u,version:"0.0.4"};t.default=a,t.Model=r,t.LegacyModel=c,t.storeModule=n,t.install=u,Object.defineProperty(t,"__esModule",{value:!0})});